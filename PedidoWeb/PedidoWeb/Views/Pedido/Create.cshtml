
@{
    ViewBag.Title = "Create";

}    
    <div class="principal1coluna">
        <h2>Novo Pedido</h2>
        <hr />
        <br />

        <div class="form-group">
            * @Html.Label("Vendedor")
            @Html.DropDownList("VendedorID", null, new { @disabled = true, @class = "form-control" })
        </div>

        <div class="form-group">
            * @Html.Label("Filial")
            @Html.DropDownList("FilialID", null, string.Empty, new { @class="form-control"})
            <span class="error" style="visibility: hidden">Filial é obrigatória</span>        
        </div>
        
        @*<div class="form-group">
            * @Html.Label("Cliente")
            @Html.DropDownList("CadastroID", null, string.Empty, new { @class = "form-control" })
            <span class="error" style="visibility: hidden">Cliente é obrigatório</span>
        </div>*@

        <div class="form-group">
            * @Html.Label("Cliente")
            @Html.TextBox("CadastroAux", null, string.Empty, new { @class="form-control" })
            <span class="error" style="visibility: hidden">Cliente é obrigatório</span>
        </div>

        <div class="form-group">
            * @Html.Label("Operação")
            @Html.DropDownList("OperacaoID", null, string.Empty, new { @Class="form-control"})
            <span class="error" style="visibility: hidden">Operação é obrigatória</span>
        </div>

        <div class="form-group">
            * @Html.Label("Forma de Pagamento")
            @Html.DropDownList("PrazoVencimentoID", null, string.Empty, new { @class = "form-control" })
            <span class="error" style="visibility: hidden">Prazo de Vencimento</span>
        </div> 
        
        
            
        <button type="button" style="min-width:160px" id="btOpcionais" class="btn btn-default" onclick="toggleDiv('opcionais')">
            @*<span id="testeglyph2" class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span>*@
            Mais Informações
        </button>
                
        <div id="opcionais" class="opcionais" style="display: none">
            
            <div>
                @Html.Label("Número (opcional)")
                @Html.TextBox("NumeroPedido", null, new { @class = "form-control" })
                <span class="error" style="visibility: hidden">Número inválido</span>
            </div>
            <div class="form-group">
                @Html.Label("Transportador (opcional)")
                @Html.DropDownList("TransportadorID", null, string.Empty, new { @class = "form-control" })
            </div>

            <div class="form-group">
                @Html.Label("Tipo de Frete (opcional)")
                @Html.DropDownList("TipoFrete",
                new List<SelectListItem>() { new SelectListItem(){Text="CIF", Value="CIF"},
                    new SelectListItem(){Text="FOB", Value="FOB" }}, string.Empty, new { @class = "form-control" })
            </div>

            <div class="form-group">
                @Html.Label("Ordem de Compra (opcional)")
                <input type="text" id="OrdemCompra" class="form-control" />
            </div>

            <div class="form-group">
                @Html.Label("Observação (opcional)")
                <textarea id="Observacao" class="form-control"></textarea>
            </div>

        </div>

        <br />        
        
        <div class="details">
            <h2>Itens do Pedido</h2>
            <hr />
            <br />

            <div id="MsgAddItem" class="alert alert-success">
                <p>Item adicionado com sucesso. Você pode adicionar mais itens ao pedido.</p>
            </div>

            @*@{AjaxOptions ajaxOptions = new AjaxOptions() {
                  UpdateTargetId = "ValorUnitario",
                  OnSuccess = "SuccessRequest",
                  OnFailure = "FailureRequest",
                  HttpMethod = "POST"
              };
            }
            
            @using (Ajax.BeginForm("ValorUnitario", "Pedido", ajaxOptions)) { 
                <div class="form-group">
                    * @Html.Label("Produto")
                    @Html.DropDownList("ProdutoID", null, string.Empty, new { @class="form-control", onchange="buscaValor()"})
                    <span class="error" style="visibility: hidden">Produto é obrigatório</span>                                
                </div>
                
                <script type="text/javascript">
                    function buscaValor() {                        
                        $("#ProdutoID").submit();                        
                    }

                    function SuccessRequest(response) {
                        //alert(response);
                        $('#ValorUnitario').val(response);
                    }

                    function FailureRequest(response) {
                        alert("Não foi possível buscar o preço do produto");
                    }
                </script>    
            }*@            
            
            <div class="form-group">
                @Html.Label("* Produto")
                @Html.TextBox("ProdutoAux", null, string.Empty, new { @class = "form-control"})
                <span class="error" style="visibility: hidden">Produto é obrigatório</span>
            </div>            

            <div class="form-group">
                * @Html.Label("Valor Unitário")
                <input type="text" id="ValorUnitario" class="form-control" />
                <span class="error" style="visibility: hidden">Valor Unitário é obrigatório</span>
            </div>       

            <div class="form-group">
                * @Html.Label("Quantidade")
                <input type="text" id="Quantidade" class="form-control" />
                <span class="error" style="visibility: hidden">Quantidade é obrigatória</span>
            </div>

            <div class="form-group col-md-5" style="padding: 0 0 0 0">                
                @Html.Label("Percentual de Desconto")
                <input type="text" id="PercDesconto" name="PercDesconto" class="form-control" />
                <span class="error" style="visibility: hidden">Percentual de desconto inválido</span>
                               
            </div>
            <div class="form-group col-md-2">
                
            </div>
            <div class="form-group col-md-5" style="padding: 0 0 0 0">                
                @Html.Label("Valor de Desconto")
                <input type="text" id="ValorDesconto" name="ValorDesconto" class="form-control" />
                <span class="error" style="visibility: hidden">Valor de desconto inválido</span>
            </div>            

            <div class="clearfix"></div>

            <div class="form-group">
                @Html.Label("Observação do Item (opcional)")
                <textarea id="ObservacaoItem" class="form-control"></textarea>
                <span class="error" style="visibility: hidden">Observação não pode ter mais de 30 caracteres</span>               
            </div>            
            
            <div class="col-md-6">
                @*<input type="button" id="add" value="Salvar Item" class="btn btn-default btn-group-justified" />*@
                <button type="button" id="add" class="btn btn-default btn-group-justified">
                    <span class="glyphicon glyphicon-ok"></span>
                    Salvar Item
                </button>
            </div>

            <div class="col-md-6">
                @*<input type="button" id="del" value="Cancelar Inclusão" class="btn btn-danger btn-group-justified" />*@
                <button type="button" id="del" class="btn btn-danger btn-group-justified">
                    <span class="glyphicon glyphicon-remove"></span>
                    Cancelar Item
                </button>
            </div>
                
            <div class="clearfix"></div>
            <br />        
            <div id="pedidoItens"></div>  
            <div id="totalPedido"></div>  
            <hr />        
            <br />
            
        </div>

        <div class="col-md-6">
            @*<input type="button" id="submit" value="Salvar Pedido" class="btn btn-primary btn-group-justified" />*@
            <button type="button" id="submit" class="btn btn-primary btn-group-justified">
                <span class="glyphicon glyphicon-floppy-disk"></span>
                Salvar Pedido
            </button>

        </div>
        <div class="col-md-6">
            @*<input type="button" id="voltar" value="Sair sem salvar" class="btn btn-danger btn-group-justified" />*@
            @*<button type="button" id="voltar" class="btn btn-danger btn-group-justified">
                <span class="glyphicon glyphicon-share-alt"></span>
                Sair sem Salvar
            </button>*@
            <a href="@Url.Action("Index")" class="btn btn-danger btn-group-justified" >
                <span class="glyphicon glyphicon-share-alt"></span>
                Sair sem Salvar
            </a>
        </div>
        <div class="clearfix"></div>

    </div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/jqueryui")   
    @Scripts.Render("~/bundles/jqueryui/stylesheet")
        
    <script>       

        function toggleDiv(divid) {
            var div = document.getElementById(divid);
            var disp = div.style.display;
            div.style.display = disp == 'none' ? 'block' : 'none';
            
            //var glyph = document.getElementById('testeglyph1');
            //var glyph2 = document.getElementById('testeglyph2');            
            
            //glyph.style.display = disp == 'none' ? 'none' : 'block';
            //glyph2.style.display = disp == 'none' ? 'block' : 'none';
            
            var bt = document.getElementById('btOpcionais');
            
            if (disp == 'none') {                
                bt.innerText = 'Menos Informações';
            }
            if (disp == 'block') {
                bt.innerText = 'Mais Informações';
            }
        };

        $("document").ready(function () {           

            var produtoSelecionado = 0;
            var cadastroSelecionado = 0;
            var descProdutoSelecionado = '';
            
            $('#ProdutoAux').autocomplete({
                source: function (request, response) {
                    // prepare url : for example '/api/artistapi?query=sonu
                    var autocompleteUrl = '/Pedido/ProdutoAutoComplete' + '?term=' + request.term;
                    $.ajax({
                        url: autocompleteUrl,
                        type: 'GET',
                        cache: false,
                        dataType: 'json',
                        success: function (json) {                            
                            var autoc = [];
                            $.each(json, function (id, data) {                                
                                autoc.push({
                                    label: data.Descricao,                                                                   
                                    value: data.ProdutoID,
                                    valor: data.PrecoVarejo
                                });
                            });
                            response(autoc);
                        },
                        error: function (xmlHttpRequest, textStatus, errorThrown) {
                            alert('Erro', textStatus, errorThrown);
                        }
                    });
                },
                minLength: 0,
                select: function (event, ui, json) {                    
                    //alert('you have selected ' + ui.item.label + ' ID: ' + ui.item.value + 'Valor ' + ui.item.valor );
                    $('#ProdutoAux').val(ui.item.label);
                    $('#ValorUnitario').val(ui.item.valor);
                    DescProdutoSelecionado = ui.item.label;
                    produtoSelecionado = ui.item.value;
                    return false;
                }
            });           

            $('#CadastroAux').autocomplete({
                source: function (request, response) {
                    // prepare url : for example '/api/artistapi?query=sonu
                    var autocompleteUrl = '/Pedido/CadastroAutoComplete' + '?term=' + request.term;
                    $.ajax({
                        url: autocompleteUrl,
                        type: 'GET',
                        cache: false,
                        dataType: 'json',
                        success: function (json) {
                            var autoc = [];
                            $.each(json, function (id, data) {
                                autoc.push({
                                    label: data.Nome,
                                    value: data.CadastroID                                    
                                });
                            });
                            response(autoc);
                        },
                        error: function (xmlHttpRequest, textStatus, errorThrown) {
                            alert('Erro', textStatus, errorThrown);
                        }
                    });
                },
                minLength: 0,
                select: function (event, ui, json) {
                    //alert('you have selected ' + ui.item.label + ' ID: ' + ui.item.value);
                    $('#CadastroAux').val(ui.item.label);
                    cadastroSelecionado = ui.item.value;                    
                    return false;
                }
            });
            
            $("#VendedorID").prop("disabled", true);
            $("#ValorDesconto").prop("disabled", true);
            $("#MsgAddItem").hide();
            $("#testeglyph2").hide();
            
            var valorUnitario = '@(ViewBag.Empresa.AlteraValorUnitario)';
            var percDesconto = '@(ViewBag.Empresa.DescontoInformado)'; 
            
            if(valorUnitario.toString() === 'True')
                $("#ValorUnitario").prop("disabled", false);
            else
                $("#ValorUnitario").prop("disabled", true);
            if(percDesconto.toString() === 'True')
                $("#PercDesconto").prop("disabled", false);
            else
                $("#PercDesconto").prop("disabled", true);

            var pedidoItens = [];
            var totalPedido = 0;

            // Add desconto change function        
            $('#PercDesconto').change(function () {
                var percDesconto = Number($('#PercDesconto').val().replace(',', '.'));
                var valUnitario = Number($('#ValorUnitario').val().replace(',', '.'));

                if (isNaN(percDesconto)) {
                    $('#PercDesconto').siblings('span.error').css('visibility', 'visible');
                }
                else {
                    $('#ValorDesconto').val(parseFloat(percDesconto * valUnitario / 100).toFixed(2).replace('.', ','));
                }
            })

            // Add  CancelaItem change function
            $('#del').click(function () {
                $('#ProdutoAux').val('').focus();
                $('#Quantidade').val('');
                $('#ValorUnitario').val('');
                $('#ObservacaoItem').val('');
                $('#PercDesconto').val('');
                $('#ValorDesconto').val('');
            });

            // Add button click function
            $('#add').click(function () {
                // Validações                
                var isValidItem = true;
                if ($('#ProdutoAux').val().trim() == '' || produtoSelecionado == 0) {
                    isValidItem = false;
                    $('#ProdutoAux').siblings('span.error').css('visibility', 'visible');
                }
                else {
                    $('#ProdutoAux').siblings('span.error').css('visibility', 'hidden');
                }

                if ($('#Quantidade').val().trim() == '' || isNaN($('#Quantidade').val().trim().replace(',', '.'))) {
                    isValidItem = false;
                    $('#Quantidade').siblings('span.error').css('visibility', 'visible');
                }
                else {
                    $('#Quantidade').siblings('span.error').css('visibility', 'hidden');
                }

                if ($('#ValorUnitario').val().trim() == '' || isNaN($('#ValorUnitario').val().trim().replace(',', '.'))) {
                    isValidItem = false;
                    $('#ValorUnitario').siblings('span.error').css('visibility', 'visible');
                }
                else {
                    $('#ValorUnitario').siblings('span.error').css('visibility', 'hidden');
                }

                if ($('#ObservacaoItem').val().length > 30) {
                    isValidItem = false;
                    $('#ObservacaoItem').siblings('span.error').css('visibility', 'visible');
                }
                else {
                    $('#ObservacaoItem').siblings('span.error').css('visibility', 'hidden');
                }

                if (isNaN($('#PercDesconto').val().trim().replace(',', '.'))) {
                    isValidItem = false;
                    $('#PercDesconto').siblings('span.error').css('visibility', 'visible');
                } else {
                    $('#PercDesconto').siblings('span.error').css('visibility', 'hidden');
                }

                // Add item to list if valid
                if (isValidItem) {                    
                    //var el = document.getElementById('ProdutoAux');
                    
                    pedidoItens.push({
                        //ProdutoID: $('#ProdutoAux').val().trim(),
                        ProdutoID: produtoSelecionado,
                        Quantidade: $('#Quantidade').val().trim().replace('.',','),
                        ValorUnitario: $('#ValorUnitario').val().trim().replace('.', ','),
                        Observacao: $('#ObservacaoItem').val().trim(),
                        //DescProduto: el.options[el.selectedIndex].text,
                        DescProduto: descProdutoSelecionado,
                        ValorDesconto: $('#ValorDesconto').val().trim().replace('.', ','),
                        PercentualDesconto: $('#PercDesconto').val().trim().replace('.', ',')                        
                    });
                    
                    totalPedido += (Number($('#Quantidade').val().trim().replace(',', '.'))
                        * Number($('#ValorUnitario').val().trim().replace(',', '.')))
                        - (Number($('#Quantidade').val().trim().replace(',', '.'))
                        * Number($('#ValorDesconto').val().trim().replace(',', '.')));
                    
                    $('#ProdutoAux').val('').focus();
                    $('#Quantidade').val('');
                    $('#ValorUnitario').val('');
                    $('#ObservacaoItem').val('');
                    $('#PercDesconto').val('');
                    $('#ValorDesconto').val('');
                    produtoSelecionado = 0;
                    $("#MsgAddItem").show();                    
                    setTimeout("$('#MsgAddItem').hide()", 3500);
                }
                GeneratedItemsTable();                
            });

            // Save button click function
            $('#submit').click(function () {

                // Validação do pedido
                var isValidOrder = true;

                if ($('#CadastroAux').val().trim() == '' || cadastroSelecionado == 0) {
                    isValidOrder = false;
                    $('#CadastroAux').siblings('span.error').css('visibility', 'visible');
                    $('#CadastroAux').focus();
                }
                else {
                    $('#CadastroAux').siblings('span.error').css('visibility', 'hidden');
                }

                if ($('#PrazoVencimentoID').val().trim() == '') {
                    isValidOrder = false;
                    $('#PrazoVencimentoID').siblings('span.error').css('visibility', 'visible');
                    $('#PrazoVencimentoID').focus();
                }
                else {
                    $('#PrazoVencimentoID').siblings('span.error').css('visibility', 'hidden');
                }

                if (isNaN($('#NumeroPedido').val().trim())) {
                    isValidOrder = false;
                    $('#NumeroPedido').siblings('span.error').css('visibility', 'visible');
                    $('#NumeroPedido').focus();
                } else {
                    $('#NumeroPedido').siblings('span.error').css('visibility', 'hidden');
                }

                if ($('#OperacaoID').val().trim() == '') {
                    isValidOrder = false;
                    $('#OperacaoID').siblings('span.error').css('visibility', 'visible');
                    $('#OperacaoID').focus();
                } else {
                    $('#OperacaoID').siblings('span.error').css('visibility', 'hidden');
                }

                if ($('#FilialID').val().trim() == '') {
                    isValidOrder = false;
                    $('#FilialID').siblings('span.error').css('visibility', 'visible');
                    $('#FilialID').focus();
                } else {
                    $('#FilialID').siblings('span.error').css('visibility', 'hidden');
                }

                // Salvar
                if (isValidOrder) {
                    var data = {
                        //CadastroID: $('#CadastroAux').val().trim(),
                        CadastroID: cadastroSelecionado,
                        PrazoVencimentoID: $('#PrazoVencimentoID').val().trim(),
                        VendedorID: $('#VendedorID').val().trim(),
                        TransportadorID: $('#TransportadorID').val().trim(),
                        TipoFrete: $('#TipoFrete').val().trim(),
                        OrdemCompra: $('#OrdemCompra').val().trim(),
                        Observacao: $('#Observacao').val().trim(),
                        NumeroPedido: $('#NumeroPedido').val().trim(),
                        OperacaoID: $('#OperacaoID').val().trim(),
                        CodEmpresa: '@(ViewBag.Empresa.CodEmpresa)',
                        FilialID: $('#FilialID').val().trim(),
                        Itens: pedidoItens
                    }

                    cadastroSelecionado = 0;

                    $(this).val('Por favor aguarde...');

                    $.ajax({
                        url: '/Pedido/SalvaPedido',
                        type: 'POST',
                        data: JSON.stringify(data),
                        datatype: "JSON",
                        contentType: "application/json",
                        success: function (d) {
                            // Checa se o pedido foi salvo no banco de dados
                            if (d.status == true) {
                                window.location.href = '/Pedido/Index';
                            }
                            else {
                                alert(d.errorMessage);
                            }

                        },
                        error: function () {
                            alert('Erro ao salvar pedido. Por favor tente novamente.');
                        }
                    })
                }
            })


            // Function for show added items in table
            function GeneratedItemsTable() {
                if (pedidoItens.length > 0) {
                    var $div = $('<div class="table-responsive"></table>');
                    var $table = $('<table class="table table-responsive table-striped"></table>');
                    $table.append('<thead><tr><th>Produto</th><th></th><th>Quantidade</th><th>Desconto Unitário</th><th>Valor Unitário</th><th></th></tr></thead>');
                    var $tbody = $('<tbody />');
                    $.each(pedidoItens, function (i, val) {
                        var $row = $('<tr/>');
                        $row.append($('<td/>').html(val.ProdutoID));
                        $row.append($('<td/>').html(val.DescProduto));
                        $row.append($('<td/>').html(val.Quantidade));
                        if (val.ValorDesconto == '')
                            $row.append($('<td/>').html('0.00'));
                        else
                            $row.append($('<td/>').html(parseFloat(val.ValorDesconto).toFixed(2)));
                        $row.append($('<td/>').html(val.ValorUnitario));
                        $row.append($('<td><button id=excluir class="btn btn-danger">Excluir</button></td>').click(function () {
                            for (var i in pedidoItens) {
                                if (pedidoItens[i].ProdutoID == val.ProdutoID
                                    && pedidoItens[i].Quantidade == val.Quantidade
                                    && pedidoItens[i].ValorUnitario == val.ValorUnitario
                                    && pedidoItens[i].Observacao == val.Observacao
                                    && pedidoItens[i].ValorDesconto == val.ValorDesconto) {
                                    pedidoItens.splice(i, 1);
                                    totalPedido -= ((val.Quantidade.trim().replace(',', '.')
                                        * val.ValorUnitario.trim().replace(',', '.'))
                                        - (val.Quantidade.trim().replace(',', '.') * val.ValorDesconto.trim().replace(',', '.')));
                                    GeneratedItemsTable();
                                }
                            }
                        }));

                        $tbody.append($row);
                    });
                    $table.append($tbody);
                    $div.append($table);
                    $('#pedidoItens').html($div);
                }
                else {
                    $('#pedidoItens').html('');
                }

                if (isNaN(totalPedido)) {
                    $('#totalPedido').html(
                        '<p class="label label-default">'
                        + 'Total do Pedido R$: 0.00'
                        + '</p>'
                        );
                    totalPedido = 0;
                } else {
                    $('#totalPedido').html(
                        '<p class="label label-default">'
                        + 'Total do Pedido R$: '
                        + parseFloat(totalPedido).toFixed(2)
                        + '</p>'
                        );
                }
            };
        });
    </script>
}