
@{
    ViewBag.Title = "Create";

}    
    <div class="principal1coluna">
        <h2>Novo Pedido</h2>
        <hr />
        <br />

        <div class="form-group">
            * @Html.Label("Vendedor")
            @Html.DropDownList("VendedorID", null, new { @disabled = true, @class = "form-control" })
        </div>

        <div>
            @Html.Label("Número")
            @Html.TextBox("NumeroPedido", null, new { @class="form-control"})
            <span class="error" style="visibility: hidden">Número inválido</span>
        </div>
        
        <div class="form-group">
            * @Html.Label("Cliente")
            @Html.DropDownList("CadastroID", null, string.Empty, new { @class = "form-control" })
            <span class="error" style="visibility: hidden">Cliente é obrigatório</span>
        </div>

        <div class="form-group">
            * @Html.Label("Operação")
            @Html.DropDownList("OperacaoID", null, string.Empty, new { @Class="form-control"})
            <span class="error" style="visibility: hidden">Operação é obrigatória</span>
        </div>

        <div class="form-group">
            * @Html.Label("Forma de Pagamento")
            @Html.DropDownList("PrazoVencimentoID", null, new { @class = "form-control" })
            <span class="error" style="visibility: hidden">Prazo de Vencimento</span>
        </div>        

        <div class="form-group">
            @Html.Label("Transportador")
            @Html.DropDownList("TransportadorID", null, string.Empty, new { @class = "form-control" })            
        </div>

        <div class="form-group">
            @Html.Label("Tipo de Frete")
            @Html.DropDownList("TipoFrete",
                new List<SelectListItem>() { new SelectListItem(){Text="CIF", Value="CIF"},
                    new SelectListItem(){Text="FOB", Value="FOB" }}, string.Empty, new { @class = "form-control" })            
        </div>


        <div class="form-group">
            @Html.Label("Ordem de Compra")            
            <input type="text" id="OrdemCompra" class="form-control"/>
        </div>

        <div class="form-group">
            @Html.Label("Observação")                        
            <textarea id="Observacao" class="form-control"></textarea>       
        </div>

        <br />        
        
        <div class="details">
            <h2>Itens do Pedido</h2>
            <hr />
            <br />

            @{AjaxOptions ajaxOptions = new AjaxOptions() {
                  UpdateTargetId = "ValorUnitario",
                  OnSuccess = "SuccessRequest",
                  OnFailure = "FailureRequest",
                  HttpMethod = "POST"
              };
            }
            
            @using (Ajax.BeginForm("ValorUnitario", "Pedido", ajaxOptions)) { 
                <div class="form-group">
                    * @Html.Label("Produto")
                    @Html.DropDownList("ProdutoID", null, string.Empty, new { @class="form-control", onchange="buscaValor()"})
                    <span class="error" style="visibility: hidden">Produto é obrigatório</span>                                
                </div>
                
                <script type="text/javascript">
                    function buscaValor() {                        
                        $("#ProdutoID").submit();                        
                    }

                    function SuccessRequest(response) {
                        //alert(response);
                        $('#ValorUnitario').val(response);
                    }

                    function FailureRequest(response) {
                        alert("Não foi possível buscar o preço do produto");
                    }
                </script>    
            }

            <div class="form-group">
                * @Html.Label("Valor Unitário")
                <input type="text" id="ValorUnitario" class="form-control" />
                <span class="error" style="visibility: hidden">Valor Unitário é obrigatório</span>
            </div>       

            <div class="form-group">
                * @Html.Label("Quantidade")
                <input type="text" id="Quantidade" class="form-control" />
                <span class="error" style="visibility: hidden">Quantidade é obrigatória</span>
            </div>

            <div class="form-group col-md-5" style="padding: 0 0 0 0">                
                @Html.Label("Percentual de Desconto")
                <input type="text" id="PercDesconto" name="PercDesconto" class="form-control" />
                <span class="error" style="visibility: hidden">Percentual de desconto inválido</span>
                               
            </div>
            <div class="form-group col-md-2">
                
            </div>
            <div class="form-group col-md-5" style="padding: 0 0 0 0">                
                @Html.Label("Valor de Desconto")
                <input type="text" id="ValorDesconto" name="ValorDesconto" class="form-control" />
                <span class="error" style="visibility: hidden">Valor de desconto inválido</span>
            </div>            

            <div class="clearfix"></div>

            <div class="form-group">
                @Html.Label("Observação do Item")
                <textarea id="ObservacaoItem" class="form-control"></textarea>
                <span class="error" style="visibility: hidden">Observação não pode ter mais de 30 caracteres</span>               
            </div>            
            
            <div class="col-md-6">
                @*<input type="button" id="add" value="Salvar Item" class="btn btn-default btn-group-justified" />*@
                <button type="button" id="add" class="btn btn-default btn-group-justified">
                    <span class="glyphicon glyphicon-ok"></span>
                    Salvar Item
                </button>
            </div>

            <div class="col-md-6">
                @*<input type="button" id="del" value="Cancelar Inclusão" class="btn btn-danger btn-group-justified" />*@
                <button type="button" id="del" class="btn btn-danger btn-group-justified">
                    <span class="glyphicon glyphicon-remove"></span>
                    Cancelar Item
                </button>
            </div>
                
            <div class="clearfix"></div>
            <br />        
            <div id="pedidoItens"></div>  
            <div id="totalPedido"></div>  
            <hr />        
            <br />
            
        </div>

        <div class="col-md-6">
            @*<input type="button" id="submit" value="Salvar Pedido" class="btn btn-primary btn-group-justified" />*@
            <button type="button" id="submit" class="btn btn-primary btn-group-justified">
                <span class="glyphicon glyphicon-floppy-disk"></span>
                Salvar Pedido
            </button>

        </div>
        <div class="col-md-6">
            @*<input type="button" id="voltar" value="Sair sem salvar" class="btn btn-danger btn-group-justified" />*@
            @*<button type="button" id="voltar" class="btn btn-danger btn-group-justified">
                <span class="glyphicon glyphicon-share-alt"></span>
                Sair sem Salvar
            </button>*@
            <a href="@Url.Action("Index")" class="btn btn-danger btn-group-justified" >
                <span class="glyphicon glyphicon-share-alt"></span>
                Sair sem Salvar
            </a>
        </div>
        <div class="clearfix"></div>

    </div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/jqueryui")   
    
    <script>

        $("#VendedorID").prop("disabled", true);
        $("#ValorDesconto").prop("disabled", true);
        $("#ValorUnitario").prop("disabled", true);

        $("document").ready(function () {
            var pedidoItens = [];
            var totalPedido = 0;

            // Add desconto change function        
            $('#PercDesconto').change(function () {
                var percDesconto = Number($('#PercDesconto').val().replace(',', '.'));
                var valUnitario = Number($('#ValorUnitario').val().replace(',', '.'));

                if (isNaN(percDesconto)) {
                    $('#PercDesconto').siblings('span.error').css('visibility', 'visible');
                }
                else {
                    $('#ValorDesconto').val(parseFloat(percDesconto * valUnitario / 100).toFixed(2).replace('.', ','));
                }
            })

            // Add  CancelaItem change function
            $('#del').click(function () {
                $('#ProdutoID').val('').focus();
                $('#Quantidade').val('');
                $('#ValorUnitario').val('');
                $('#ObservacaoItem').val('');
                $('#PercDesconto').val('');
                $('#ValorDesconto').val('');
            });

            // Add button click function
            $('#add').click(function () {
                // Validações
                var isValidItem = true;
                if ($('#ProdutoID').val().trim() == '') {
                    isValidItem = false;
                    $('#ProdutoID').siblings('span.error').css('visibility', 'visible');
                }
                else {
                    $('#ProdutoID').siblings('span.error').css('visibility', 'hidden');
                }

                if ($('#Quantidade').val().trim() == '' || isNaN($('#Quantidade').val().trim().replace(',', '.'))) {
                    isValidItem = false;
                    $('#Quantidade').siblings('span.error').css('visibility', 'visible');
                }
                else {
                    $('#Quantidade').siblings('span.error').css('visibility', 'hidden');
                }

                if ($('#ValorUnitario').val().trim() == '' || isNaN($('#ValorUnitario').val().trim().replace(',', '.'))) {
                    isValidItem = false;
                    $('#ValorUnitario').siblings('span.error').css('visibility', 'visible');
                }
                else {
                    $('#ValorUnitario').siblings('span.error').css('visibility', 'hidden');
                }

                if ($('#ObservacaoItem').val().length > 30) {
                    isValidItem = false;
                    $('#ObservacaoItem').siblings('span.error').css('visibility', 'visible');
                }
                else {
                    $('#ObservacaoItem').siblings('span.error').css('visibility', 'hidden');
                }

                if (isNaN($('#PercDesconto').val().trim().replace(',', '.'))) {
                    isValidItem = false;
                    $('#PercDesconto').siblings('span.error').css('visibility', 'visible');
                } else {
                    $('#PercDesconto').siblings('span.error').css('visibility', 'hidden');
                }

                // Add item to list if valid
                if (isValidItem) {
                    var el = document.getElementById('ProdutoID');
                    pedidoItens.push({
                        ProdutoID: $('#ProdutoID').val().trim(),
                        Quantidade: $('#Quantidade').val().trim(),
                        ValorUnitario: $('#ValorUnitario').val().trim(),
                        Observacao: $('#ObservacaoItem').val().trim(),
                        DescProduto: el.options[el.selectedIndex].text,
                        ValorDesconto: $('#ValorDesconto').val().trim(),
                        PercentualDesconto: $('#PercDesconto').val().trim()
                    });


                    totalPedido += (Number($('#Quantidade').val().trim().replace(',', '.'))
                        * Number($('#ValorUnitario').val().trim().replace(',', '.')))
                        - (Number($('#Quantidade').val().trim().replace(',', '.'))
                        * Number($('#ValorDesconto').val().trim().replace(',', '.')));

                    $('#ProdutoID').val('').focus();
                    $('#Quantidade').val('');
                    $('#ValorUnitario').val('');
                    $('#ObservacaoItem').val('');
                    $('#PercDesconto').val('');
                    $('#ValorDesconto').val('');
                }
                GeneratedItemsTable();
            });

            // Save button click function
            $('#submit').click(function () {

                // Validação do pedido
                var isValidOrder = true;

                if ($('#CadastroID').val().trim() == '') {
                    isValidOrder = false;
                    $('#CadastroID').siblings('span.error').css('visibility', 'visible');
                    $('#CadastroID').focus();
                }
                else {
                    $('#CadastroID').siblings('span.error').css('visibility', 'hidden');
                }

                if ($('#PrazoVencimentoID').val().trim() == '') {
                    isValidOrder = false;
                    $('#PrazoVencimentoID').siblings('span.error').css('visibility', 'visible');
                    $('#PrazoVencimentoID').focus();
                }
                else {
                    $('#PrazoVencimentoID').siblings('span.error').css('visibility', 'hidden');
                }

                if (isNaN($('#NumeroPedido').val().trim())) {
                    isValidOrder = false;
                    $('#NumeroPedido').siblings('span.error').css('visibility', 'visible');
                    $('#NumeroPedido').focus();
                } else {
                    $('#NumeroPedido').siblings('span.error').css('visibility', 'hidden');
                }

                if ($('#OperacaoID').val().trim() == '') {
                    isValidOrder = false;
                    $('#OperacaoID').siblings('span.error').css('visibility', 'visible');
                    $('#OperacaoID').focus();
                } else {
                    $('#OperacaoID').siblings('span.error').css('visibility', 'hidden');
                }

                // Salvar
                if (isValidOrder) {
                    var data = {
                        CadastroID: $('#CadastroID').val().trim(),
                        PrazoVencimentoID: $('#PrazoVencimentoID').val().trim(),
                        VendedorID: $('#VendedorID').val().trim(),
                        TransportadorID: $('#TransportadorID').val().trim(),
                        TipoFrete: $('#TipoFrete').val().trim(),
                        OrdemCompra: $('#OrdemCompra').val().trim(),
                        Observacao: $('#Observacao').val().trim(),
                        NumeroPedido: $('#NumeroPedido').val().trim(),
                        OperacaoID : $('#OperacaoID').val().trim(),
                        Itens: pedidoItens
                    }

                    $(this).val('Por favor aguarde...');

                    $.ajax({
                        url: '/Pedido/SalvaPedido',
                        type: 'POST',
                        data: JSON.stringify(data),
                        datatype: "JSON",
                        contentType: "application/json",
                        success: function (d) {
                            // Checa se o pedido foi salvo no banco de dados
                            if (d.status == true) {
                                window.location.href = '/Pedido/Index';
                            }
                            else {
                                alert(d.errorMessage);
                            }

                        },
                        error: function () {
                            alert('Erro ao salvar pedido. Por favor tente novamente.');
                        }
                    })
                }
            })


            // Function for show added items in table
            function GeneratedItemsTable() {
                if (pedidoItens.length > 0) {
                    var $div = $('<div class="table-responsive"></table>');
                    var $table = $('<table class="table table-responsive table-striped"></table>');
                    $table.append('<thead><tr><th>Produto</th><th></th><th>Quantidade</th><th>Desconto Unitário</th><th>Valor Unitário</th><th></th></tr></thead>');
                    var $tbody = $('<tbody />');
                    $.each(pedidoItens, function (i, val) {
                        var $row = $('<tr/>');
                        $row.append($('<td/>').html(val.ProdutoID));
                        $row.append($('<td/>').html(val.DescProduto));
                        $row.append($('<td/>').html(val.Quantidade));                        
                        if (val.ValorDesconto == '')
                            $row.append($('<td/>').html('0.00'));
                        else
                            $row.append($('<td/>').html(parseFloat(val.ValorDesconto).toFixed(2)));
                        $row.append($('<td/>').html(val.ValorUnitario));
                        $row.append($('<td><button id=excluir class="btn btn-danger">Excluir</button></td>').click(function () {
                            for (var i in pedidoItens) {
                                if (pedidoItens[i].ProdutoID == val.ProdutoID
                                    && pedidoItens[i].Quantidade == val.Quantidade
                                    && pedidoItens[i].ValorUnitario == val.ValorUnitario
                                    && pedidoItens[i].Observacao == val.Observacao
                                    && pedidoItens[i].ValorDesconto == val.ValorDesconto) {
                                    pedidoItens.splice(i, 1);
                                    totalPedido -= ((val.Quantidade.trim().replace(',', '.')
                                        * val.ValorUnitario.trim().replace(',', '.'))
                                        - (val.Quantidade.trim().replace(',', '.') * val.ValorDesconto.trim().replace(',', '.')));
                                    GeneratedItemsTable();
                                }
                            }
                        }));


                        $tbody.append($row);
                    });
                    $table.append($tbody);
                    $div.append($table);
                    $('#pedidoItens').html($div);
                }
                else {
                    $('#pedidoItens').html('');
                }

                if (isNaN(totalPedido)) {
                    $('#totalPedido').html(
                        '<p class="label label-default">'
                        + 'Total do Pedido R$: 0.00'
                        + '</p>'
                        );
                    totalPedido = 0;
                } else {
                    $('#totalPedido').html(
                        '<p class="label label-default">'
                        + 'Total do Pedido R$: '
                        + parseFloat(totalPedido).toFixed(2)
                        + '</p>'
                        );
                }
            }

        });
    </script>
}